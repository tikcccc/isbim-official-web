页面转场动画性能优化计划
问题总结
页面转场动画卡顿的根本原因：
maskPosition 动画不走 GPU 加速 - 每帧触发 paint 操作（最严重）
嵌套的 skewX + translateX - 导致昂贵的复合层计算
Lenis 滚动冲突 - 1.2s 滚动动画与 0.9s 页面转场时间不匹配
ScrollTrigger 多次刷新 - 在转场期间触发 3 次重计算
滚动恢复时机错误 - 在动画同一帧执行，造成布局抖动
无限循环的 shimmer 动画 - 持续消耗 GPU 资源
优化方案
1. 修复 Logo Shimmer 动画（Critical）
文件: page-transition.tsx:88-113 当前问题:
// ❌ 使用 maskPosition - 不走 GPU
animate={{
  maskPosition: ['-120% 0', '220% 0'],
}}
优化方案:
// ✅ 改用 translateX - GPU 加速
// 1. 在 mask 容器内部创建一个移动的渐变层
// 2. 使用 translateX 而不是 maskPosition
// 3. 只在转场期间播放，不要无限循环
// 4. 添加 will-change: transform 和 translateZ(0)
2. 优化主转场动画的 GPU 加速（Critical）
文件: page-transition.tsx:29-55 当前问题:
// ❌ 嵌套的 skew + translate，没有 GPU 提示
<m.div animate={{ x: "260vw" }}>
  <div style={{ transform: 'skewX(-20deg)' }} />
</m.div>
优化方案:
// ✅ 在 style 中合并 transform，添加 GPU 提示
<m.div
  animate={{ x: "260vw" }}
  style={{
    transform: 'translateZ(0) skewX(-20deg)', // 合并到一个 transform
    backfaceVisibility: 'hidden', // 优化复合层
  }}
/>
3. 修复滚动恢复时机（High）
文件: page-transition.tsx:148-167 当前问题:
// ❌ 在组件挂载时立即滚动，与动画同帧
useEffect(() => {
  const raf = requestAnimationFrame(() => {
    lenis.scrollTo(0, { immediate: true }); // 阻塞动画
  });
}, [lenis]);
优化方案:
// ✅ 等待退出动画完成后再滚动
// 已有 onExitComplete 回调，但首次加载需要延迟
useEffect(() => {
  const timer = setTimeout(() => {
    lenis?.scrollTo(0, { immediate: true });
  }, 100); // 延迟到动画开始后
  return () => clearTimeout(timer);
}, [lenis]);
4. 同步动画时长（High）
文件: page-transition.tsx:43-45, 100 当前问题:
主动画: 0.9s
Shimmer: 2s（无限循环）
Lenis: 1.2s
页面内容: 0.9s
优化方案:
// ✅ 统一使用 0.9s
const TRANSITION_DURATION = 0.9;

// 主动画
transition={{ duration: TRANSITION_DURATION }}

// Shimmer - 只播放一次，匹配主动画时长
transition={{
  duration: TRANSITION_DURATION,
  repeat: 0, // 不要无限循环
}}
5. 优化 Lenis 与 ScrollTrigger 冲突（High）
文件: smooth-scroll-provider.tsx:89-101 当前问题:
// ❌ 页面转场时触发 3 次 ScrollTrigger.refresh()
setTimeout(() => ScrollTrigger.refresh(), 300);
setTimeout(() => ScrollTrigger.refresh(), 1000);
window.addEventListener("load", () => ScrollTrigger.refresh());
优化方案:
// ✅ 在页面转场期间禁用 ScrollTrigger 更新
// 1. 添加状态标记：isTransitioning
// 2. 在 refresh 前检查该标记
// 3. PageTransition 通过 Context 通知转场状态
6. 添加全局 GPU 加速样式（Medium）
文件: page-transition.tsx:26 优化方案:
// ✅ 在根容器添加优化提示
<div className="fixed inset-0 z-[9999] pointer-events-none overflow-hidden"
     style={{
       perspective: 1000, // 启用 3D 上下文
       backfaceVisibility: 'hidden',
       transform: 'translate3d(0,0,0)', // 强制 GPU
     }}>
7. Debounce ScrollTrigger.update（Medium）
文件: smooth-scroll-provider.tsx:74 当前问题:
// ❌ 每次滚动都触发 update
lenis?.on('scroll', (e: any) => {
  ScrollTrigger.update();
});
优化方案:
// ✅ 使用 requestAnimationFrame 限流
lenis?.on('scroll', (e: any) => {
  if (!updateScheduled) {
    updateScheduled = true;
    requestAnimationFrame(() => {
      ScrollTrigger.update();
      updateScheduled = false;
    });
  }
});
实施步骤
Step 1: 修复 Shimmer 动画（最高优先级）
移除 maskPosition 动画
改用 translateX + clip-path 或 transform-based gradient
添加 GPU 提示
移除 infinite repeat
Step 2: 优化主转场动画
合并 skewX 到父容器
添加 translateZ(0) 和 backfaceVisibility
统一动画时长为 0.9s
Step 3: 修复滚动恢复
延迟首次滚动恢复到动画后
确保 onExitComplete 正确工作
Step 4: 优化 ScrollTrigger
添加转场状态管理
在转场期间禁用 refresh
Debounce ScrollTrigger.update
Step 5: 全局优化
添加根容器 GPU 提示
确保所有动画时长一致
关键文件
page-transition.tsx - 主要修改
smooth-scroll-provider.tsx - ScrollTrigger 优化
lazy-motion.tsx - 检查配置
预期效果
✅ 60fps 流畅转场（目前约 20-30fps）
✅ 消除视觉抖动
✅ 减少 GPU 负载
✅ 统一动画时序
✅ 修复滚动冲突